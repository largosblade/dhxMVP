$dhx.ui.mvp.model.engine.declare({backboneIDB:function(){"strict";var e=function(){var e={database:{id:"dhxMVP__999",description:"dhxMVP demo database",nolog:!0,migrations:[]},versions:{1:$dhx.ui.mvp.model.collection.get()},start:function(e){console.log("model.start() triggered"),e.onSuccess&&e.onSuccess()}},t={database:e.database,versions:e.versions,start:e.start};return t}();return e.data=function(){var t={},o={},n={_collections:t,setIoAPI:function(t,o){e.schema.io[t]=function(t){var o={model:t,create:function(t){t.model=this.model,e.schema._io._create(t)},update:function(t){t.model=this.model,e.schema._io._update(t)},destroy:function(t){t.model=this.model,e.schema._io._destroy(t)},read:function(t){t.model=this.model,e.schema._io._destroy(t)}};return o}(o)},_start:function(){console.info(" starting model.data ");for(var r in t)this.setIoAPI(r,t[r].item),o[t[r].item]=Backbone.Model.extend({database:e.database,storeName:r,nolog:!0,defaults:t[r].defaults,url:function(){return this.id?"/"+t[r].item+"/"+this.id:"/"+t[r].item},ajaxSync:function(){},incrementVersion:function(){var e=this.get("__v");console.log("version: ",e),e+=1,this.set({__v:e}),console.log('this.get("__v"): ',this.get("__v"))},initialize:function(){this.get("id"),this.on("change",this.onChange),this.on("sync",this.onSync),this.on("error",this.onError),this.on("destroy",this.onDestroy)},onSync:function(e,t,o){},onError:function(e,t,o){},onDestroy:function(e,t,o){},onChange:function(e,t,o){}}),o[r]=Backbone.Collection.extend({model:o[t[r].item],database:e.database,nolog:!0,storeName:r,url:r+".json"}),n[t[r].item]=function(e){return function(n){return new o[t[e].item](n)}}(r),n[r]=function(e){return function(){return new o[e]}}(r)}};return n}(),e.schema=function(){var t={setup:function(t){var o,n=null;for(n in e.versions){var r=Object.keys(e.versions[n]);r.forEach(function(t){var o=e.versions[n][t],r={};for(var c in o.defaults){var s=o.defaults[c];r[c]=s["default"]}e.data._collections[t]={item:o.item,defaults:r}}),o={version:parseInt(n),migrate:function(t,o){var r=[],c=Object.keys(e.versions[n]),s=c.length,a=0;console.log("store_names: ",c),c.forEach(function(o){var c=e.versions[n][o];r[o]=null,t.db.objectStoreNames.contains(o)||(r[o]=t.db.createObjectStore(o)),r[o]=t.objectStore(o);for(var i in c.defaults){var d=c.defaults[i];r[o].createIndex(i,i,{unique:d.unique||!1})}t.addEventListener("complete",function(t){a+=1,console.log(a,s),a==s&&console.log(e.data._collections)}),t.onsuccess=function(e){console.log(e)},t.addEventListener("success",function(e){console.log(e)})}),o()}},e.database.migrations.push(o)}console.info("model.schema setup is done!"),t.onSetup&&t.onSetup()},_get_collection_meta:function(t,o){var n=Object.keys(e.versions[t]),r=!1;return n.forEach(function(n){n==o&&(r=e.versions[t][n])}),r},_get_collection_item:function(t,o){var n=Object.keys(e.versions[t]),r=!1;return n.forEach(function(n){n==o&&(r=e.versions[t][n].item)}),r},_set_start_data:function(e){var o=t;return $dhx.isObject(e)?void(o.start_data=e):void alert("The start data does not have a valid format.\nApplication will not start.")},_get_start_data:function(){var e=t;return e.start_data||{}},add_all_records_from_server:function(o){var n=t,r=Object.keys(n._get_start_data()),c=(r.length,[]),s=[],a=[],i=[],d=null,l=function(e,t,o){var r=o.shift();collection_name=t.shift(),t.length>0&&o.length>0?n.insert_records_into_table(c[r],collection_name,function(n,r){l(e,t,o)}):0===t.length&&0===o.length?"undefined"==typeof r||"undefined"==typeof collection_name?e&&e():n.insert_records_into_table(c[r],collection_name,function(t,o){e&&e()}):e&&e()};r.forEach(function(t,o){d=e.schema._get_collection_item(1,t),c[d]=Backbone.Model.extend({database:e.database,storeName:t}),s[t]=Backbone.Collection.extend({database:e.database,storeName:t,model:c[d]}),a.push(t),i.push(d)}),l(function(){o.onSuccess&&o.onSuccess()},a,i)},insert_records_into_table:function(e,o,n){var r=t,c=r._get_start_data()[o].shift();c?t.io[o].create({record:c,onSuccess:function(){r.insert_records_into_table(e,o,n)},onFail:function(){console.error("error inserting record: ",c),console.warn("props: ",Object.keys(c).length)}}):n(e,o)},start:function(o){var n=t;o.onSetup=function(){e.data._start(),e.data[Object.keys(e.data._collections)[0]]().fetch({success:function(t,n,r){console.info("The collection "+Object.keys(e.data._collections)[0]+" was fetched and the indexedDB is done!"),o.onSuccess&&o.onSuccess()},error:function(e,t,o){console.log(e)}})},n.setup(o)},_io:{_create:function(t){var o,n="string"==typeof t.record?JSON.parse(t.record):t.record,r=new e.data[t.model],c=new $dhx.ui.mvp.model.helpers.schema.record({model:t.model,record:n}),s=function(e){r.save(e,{success:function(){t.onSuccess&&t.onSuccess(e)},error:function(e,o){dhtmlx.alert({text:"Error creating "+t.model+" model data locally",type:"alert-error"}),t.onFail&&t.onFail()}})};c.__v=+(c.__v||0),c.id?(o=new e.data[t.model]({id:c.id}),o.fetch({success:function(e){c.__v>e.get("__v")?s(c):(console.warn("_io._create() -> Record rejected. The version of the record is not greater than local record version.",c),t.onSuccess&&t.onSuccess(c))},error:function(e,t){"Not Found"==t&&(console.info("Document "+c.id+" not found. I will create then.",c),s(c))}})):s(c)},_update:function(t){var o="string"==typeof t.record?JSON.parse(t.record):t.record,n=new e.data[t.model]({id:o.id}),r=new $dhx.ui.mvp.model.helpers.schema.record({model:t.model,record:o}),c=0,s=function(e){n.save(e,{success:function(){t.onSuccess&&t.onSuccess(e)},error:function(e,o){dhtmlx.alert({text:"Error updating "+t.model+"  model data locally",type:"alert-error"}),t.onFail&&t.onFail()}})};n.fetch({success:function(e){if(delete r.id,delete r._id,r.__v){if("number"!=typeof r.__v)throw"fDocument version(__v) shall to be a number";if(r.__v<0)throw"fDocument version(__v) shall to greater than zero";r.__v>e.get("__v")?s(r):(console.warn("_io._update() -> Record rejected. The version of the record is not greater than local record version.",r),t.onSuccess&&t.onSuccess(r))}else c=+(e.get("__v")||0),c+=1,r.__v=c,s(r)},error:function(e,n){"Not Found"==n&&(dhtmlx.alert({text:""+t.model+" "+o.id+" not found",type:"alert-error"}),t.onSuccess&&t.onSuccess(r))}})},_destroy:function(t){var o="string"==typeof t.record?JSON.parse(t.record):t.record,n=new e.data[t.model]({id:o.id}),r=function(){n.destroy({success:function(){t.onSuccess&&t.onSuccess(o)},error:function(e,o){dhtmlx.alert({text:"Error deleting "+t.model+" model data locally",type:"alert-error"}),t.onFail&&t.onFail()}})};n.fetch({success:function(e){r()},error:function(e,n){"Not Found"==n&&(dhtmlx.alert({text:""+t.model+" "+o.id+" not found",type:"alert-error"}),t.onFail&&t.onFail())}})},_read:function(t){var o="string"==typeof t.record?JSON.parse(t.record):t.record,n=new e.data[t.model]({id:o.id});n.fetch({success:function(e){o=e.toJSON(),t.onSuccess&&t.onSuccess(e,o)},error:function(e,n){"Not Found"==n&&(dhtmlx.alert({text:""+t.model+" "+o.id+" not found",type:"alert-error"}),t.onFail&&t.onFail(e,n))}})}},io:{}};return API={start:t.start,_get_collection_meta:t._get_collection_meta,_get_collection_item:t._get_collection_item,_set_start_data:t._set_start_data,_get_start_data:t._get_start_data,add_all_records_from_server:t.add_all_records_from_server,io:t.io,_io:t._io},API}(),e}()});